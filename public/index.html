<!DOCTYPE html>
<html lang="en">
	<head>
		<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Homepage</title>
		<link href='css/style.css' rel='stylesheet' type='text/css'>
		<link href='css/weather-icons.min.css' rel='stylesheet' type='text/css'>

		<script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
		<script type="text/javascript" src="js/jquery.simpleWeather.min.js"></script>
		<script type="text/javascript" src="js/getLoadingString.js"></script>
		<script type="text/javascript">
			var weatherClasses = {
				"Showers": "wi-rain-mix",
				"Scattered Showers": "wi-showers",
				"Partly Cloudy": "wi-day-cloudy",
				"Cloudy": "wi-cloudy",
				"Rain": "wi-rain",
				"Mostly Cloudy": "wi-cloudy",
				"Scattered Thunderstorms": "wi-storm-showers",
				"Mostly Sunny": "wi-day-cloudy-high",
				"Sunny": "wi-day-sunny",
				"Clear": "wi-night-clear"
			}
		</script>
	</head>
	<body>
		<div id="MainContainer">
			<div id="MainContent">
				<div class="row weather">
					<div class="current flex">
						<div class="now">
							<div class="temp icon"></div>
							<div class="currentConditions"></div>
						</div>
						<div class="today">
							<div class="location">Palo Alto, CA</div>
							<div class="forecast"></div>
							<div class="forecastTemps"></div>
							<div class="sunset"></div>
						</div>
					</div>
					<div class="forecast"></div>
				</div>
				<div class="row bookmarks">
					<a class="item bookmark verge" href="https://theverge.com"></a>
					<a class="item bookmark ycomb" href="https://news.ycombinator.com"></a>
				</div>
				<div class="row comic xkcd">
					<h3></h3><div class="img"><img /></div><p></p>
				</div>
				<div class="row loading">
					Loading...
				</div>
				<div class="notXKCD">
					<div class="row comic smbc">
						<div class="img"><img /></div><p></p>
					</div>
					<div class="row comic dino">
						<h3></h3><div class="img"><img /></div><p></p>
					</div>
					<div class="row comic explosm">
						<div class="img"><img /></div>
					</div>
					<div class="row comic extrafab">
						<div class="img"><img /></div>
					</div>
					<div class="row comic poorly">
						<div class="img"><img /></div>
					</div>
					<div class="row comic whomp">
						<h3></h3><div class="img"><img /></div>
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript">
			$.simpleWeather({
				location: 'Palo Alto, CA',
				woeid: '',
				unit: 'f',
				success: function(weather){
					$(".weather .current .forecast").html(weather.text);
					$(".weather .current .temp").html(weather.temp+"&deg;F").addClass(weatherClasses[weather.currently]);
					$(".weather .current .currentConditions").html(weather.currently);
					$(".weather .current .forecastTemps").html(weather.high+"&deg;F / "+weather.low+"&deg;F");
					$(".weather .current .sunset").html("Sunset at "+weather.sunset);

					var forecast,day,temps;
					for(var i=1;i<6;i++){
						forecast = weather.forecast[i];
						day = $("<div class='day'></div>");
						icon = $("<div class='icon "+weatherClasses[forecast.text]+"'></div>");
						weekday = $("<div class='weekDay'>"+forecast.day+"</div>");
						condition = $("<div class='condition'>"+forecast.text+"</div>");
						temps = $("<div class='temps'>"+forecast.high+"&deg;F / "+forecast.low+"&deg;F</div>");

						day.append([weekday,icon,temps,condition]);

						$(".weather>.forecast").append(day);
					}
				},
				error: function(error){
					$(".weather").html('<p>'+error+'</p>');
				}
			});

			function populateXKCD(data){
				$(".row.xkcd h3").html(data.safe_title);
				$(".row.xkcd img").attr("src",data.img);
				$(".row.xkcd p").html(data.alt);
			}

			if(!localStorage.getItem("lastUpdateXKCD")
				|| Date.now() - localStorage.getItem("lastUpdateXKCD") > 1000*60*60*2){

				$.ajax({
					dataType: "jsonp",
					url: "//dynamic.xkcd.com/api-0/jsonp/comic/ ",
					success: function(data){
						localStorage.setItem("comicsXKCD",JSON.stringify(data));
						localStorage.setItem("lastUpdateXKCD",Date.now());

						populateXKCD(data);
					}
				});
			} else {
				populateXKCD(JSON.parse(localStorage.getItem("comicsXKCD")));
			}

			function populateComics(data){
				$(".row.smbc img").attr("src",data.smbc.img);
				$(".row.smbc p").html(data.smbc.alt);

				$(".row.explosm img").attr("src",data.explosm.img);

				$(".row.dino h3").html(data.dino.title);
				$(".row.dino img").attr("src",data.dino.img);
				$(".row.dino p").html(data.dino.alt);

				$(".row.extrafab img").attr("src",data.extrafab.img);

				$(".row.poorly img").attr("src",data.poorly.img);

				$(".row.whomp h3").html(data.whomp.title);
				$(".row.whomp img").attr("src",data.whomp.img);

				$(".notXKCD").show();
				$(".row.loading").hide();
			}

			if(!localStorage.getItem("lastUpdate")
				|| Date.now() - localStorage.getItem("lastUpdate") > 1000*60*60*2){

				$(".row.loading").text(getLoadingString());
				$.ajax({
					dataType: "json",
					url: "/feed",
					success: function(data){
						localStorage.setItem("comics",JSON.stringify(data));
						localStorage.setItem("lastUpdate",Date.now());

						populateComics(data);
					}
				});
			} else {
				populateComics(JSON.parse(localStorage.getItem("comics")));
			}
		</script>
	</body>
</html>